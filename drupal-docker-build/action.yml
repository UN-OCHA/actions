name: "Drupal Docker Build Workflow"
description: "Does docker authentication, build, push and notification."

inputs:
  aws_access_key_id:
    description: "An Amazon IAM access key"
    required: true
    type: string
  aws_secret_access_key:
    description: "An Amazon IAM access secret"
    required: true
    type: string
  docker_registry_url:
    description: "The docker registry URL"
    required: true
    type: string
  docker_registry_path:
    description: "The docker registry path (organisation) component"
    required: false
    default: '/'
    type: string
  docker_username:
    description: "The docker registry username"
    required: false
    type: string
  docker_password:
    description: "The docker registry password"
    required: false
    type: string
  docker_image:
    description: "The docker image name"
    required: true
    type: string
  ecr_github_token:
    description: "An authentication token for Amazon ECR to access GitHub"
    required: false
    type: string
  ecr_jenkins_token:
    description: "An authentication token for GitHub to access Jenkins"
    required: false
    type: string
  slack_bot_token:
    description: "The secret slack authentication token"
    require: false
    type: string
  slack_channel_name:
    description: "The slack channel to send the message to"
    require: false
    type: string
  flowdock_token:
    description: "The flowdock token"
    required: false
    type: string
  flowdock_icon_failure:
    description: "The icon to attach to the flowdock failure message"
    default: 'boom'
    required: false
    type: string
  flowdock_icon_success:
    description: "The icon to attach to the flowdock success message"
    default: 'package'
    required: false
    type: string


runs:
  using: "composite"
  steps:
  - name: Configure AWS Credentials
    id: aws
    if: ${{ inputs.ECR_AWS_ACCESS_KEY_ID }}
    uses: aws-actions/configure-aws-credentials@v1
    with:
      aws-access-key-id: ${{ inputs.aws_access_key_id }}
      aws-secret-access-key: ${{ inputs.aws_secret_access_key }}
      aws-region: us-east-1

  - name: Determine environment type
    id: env
    uses: docker://ghcr.io/un-ocha/actions:determine-environment-main

  - name: Login to Public ECR
    id: login-public
    if: inputs.docker_username
    uses: docker/login-action@f054a8b539a109f9f41c372932f1ae047eff08c9
    with:
      registry: public.ecr.aws
      username: ${{ inputs.docker_username }}
      password: ${{ inputs.docker_password }}
    env:
      AWS_REGION: us-east-1

  - name: Login to Private ECR
    id: login-private
    if: endsWith(inputs.docker_registry_url, '.amazonaws.com') && inputs.docker_username
    uses: docker/login-action@f054a8b539a109f9f41c372932f1ae047eff08c9
    with:
      registry: ${{ inputs.docker_registry_url }}
      username: ${{ inputs.docker_username }}
      password: ${{ inputs.docker_password }}
    env:
      AWS_REGION: us-east-1

  - name: Image Metadata
    id: meta
    run: |
      export DOCKER_TAG="${GITHUB_REF#refs/*/}"
      export DOCKER_TAG=${DOCKER_TAG//[^[:alnum:].-]/-}
      echo ::set-output name=DOCKER_TAG::${DOCKER_TAG}
      export VCS_REF=`git rev-parse --short HEAD`
      echo ::set-output name=VCS_REF::${VCS_REF}
      export VCS_URL=`git config --get remote.origin.url | sed 's#git@github.com:#https://github.com/#'`
      echo ::set-output name=VCS_URL::${VCS_URL}
      export BUILD_DATE=`date -u +"%Y-%m-%dT%H:%M:%SZ"`
      echo ::set-output name=BUILD_DATE::${BUILD_DATE}
    shell: bash

  - name: Build docker image
    id: build
    uses: docker/build-push-action@v2
    with:
      build-args: |
        BRANCH_ENVIRONMENT=${BRANCH_ENVIRONMENT}
        VCS_REF=${{ steps.meta.outputs.VCS_REF }}
        VCS_URL=${{ steps.meta.outputs.VCS_URL }}
        BUILD_DATE=${{ steps.meta.outputs.BUILD_DATE }}
        GITHUB_ACTOR=${{ github.actor }}
        GITHUB_REPOSITORY=${{ github.repository }}
        GITHUB_SHA=${{ github.sha }}
        GITHUB_REF=${{ github.ref }}
      labels: |
        info.humanitarianresponse.build.date=${{ steps.meta.outputs.BUILD_DATE }}
        info.humanitarianresponse.build.person=${{ github.actor }}
        info.humanitarianresponse.build.vcs-url=${{ steps.meta.outputs.VCS_URL }}
        info.humanitarianresponse.build.vcs-ref=${{ steps.meta.outputs.VCS_REF }}
      file: docker/Dockerfile
      push: true
      tags: ${{ inputs.docker_registry_url }}${{ inputs.docker_registry_path }}${{ inputs.docker_image }}:${{ steps.meta.outputs.DOCKER_TAG }}
      secrets: |
          "github_token=${{ inputs.ecr_github_token }}"

  - name: Webhook
    id: webhook
    if: success() && inputs.ecr_jenkins_token
    env:
      DOCKER_IMAGE: ${{ inputs.docker_image }}
      DOCKER_TAG: ${{ steps.meta.outputs.DOCKER_TAG }}
      JENKINS_TOKEN: ${{ inputs.ecr_jenkins_token }}
    run: |
      curl -H "Token: ${JENKINS_TOKEN}" -X POST "https://jenkins.aws.ahconu.org/generic-webhook-trigger/invoke?DOCKER_IMAGE=${DOCKER_IMAGE}&DOCKER_TAG=${DOCKER_TAG}"
    shell: bash

  - name: Slack Notification
    id: slack
    if: inputs.slack_bot_token && inputs.slack_channel_name
    uses: slackapi/slack-github-action@v1.19.0
    with:
      channel-id: '${{ inputs.slack_channel_name }}'
      payload: |
        {
          "text": "Docker image build for `${{ inputs.docker_image }}` image from ${{ github.ref }} ${{ job.status }}",
          "blocks": [
            {
              "type": "section",
              "text": {
                "type": "mrkdwn",
                "text": "Docker image build ${{ job.status }} for `${{ inputs.docker_image }}` image from ${{ github.ref }}"
              },
              "accessory": {
                "type": "button",
                "text": {
                  "type": "plain_text",
                  "text": "Details",
                  "emoji": false
                },
                "value": "run_details",
                "url": "https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
              }
            }
          ]
        }
    env:
      SLACK_BOT_TOKEN: ${{ inputs.slack_bot_token }}

  - name: Flowdock Failure
    id: failure
    if: failure() && inputs.flowdock_token
    uses: docker://ghcr.io/un-ocha/actions:flowdock-notify-main
    env:
      FLOWDOCK_TOKEN: ${{ inputs.flowdock_token }}
      FLOWDOCK_ICON: ${{ inputs.flowdock_icon_failure }}
      FLOWDOCK_MESSAGE: 'Failed to build a new `${{ inputs.docker_image }}` image from ${{ github.ref }}, please go check [GitHub](https://github.com/${{ github.repository }}/actions/workflows/docker-build-image.yml).'
      FLOWDOCK_TAGS: 'build,docker,${{ github.actor }}'

  - name: Flowdock Success
    id: success
    if: success() && inputs.flowdock_token
    uses: docker://ghcr.io/un-ocha/actions:flowdock-notify-main
    env:
      FLOWDOCK_TOKEN: ${{ inputs.flowdock_token }}
      FLOWDOCK_ICON: ${{ inputs.flowdock_icon_success }}
      FLOWDOCK_MESSAGE: 'Built a new `${{ inputs.docker_image }}` image from ${{ github.ref }} and pushed to [Amazon ECR](https://console.aws.amazon.com/ecr/repositories?region=us-east-1). Now pinging [Jenkins](https://jenkins.aws.ahconu.org/) to trigger a deploy.'
      FLOWDOCK_TAGS: 'build,docker,${{ github.actor }}'
